---
title: "Two Trait Model"
author: Lucas Eckert
output: html_document
---
```{r, echo=F, include=F}
source("R/utils.R")
source("R/mcmc.R")
source("R/functions.R")
load_pkgs()
zmargin <- theme(panel.spacing = grid::unit(0, "lines"))
theme_set(theme_bw())
library(phytools)
```

```{r, echo=F}
allData <- read.csv("data/binaryTraitData.csv", header = TRUE)
traitData <- with(allData,
                  data.frame(species, ag, care, names=species))
fullPhy <- suppressWarnings(fishtree_phylogeny(traitData$species))
trimmedData <- comparative.data(fullPhy, traitData, names.col = names)
phy <- trimmedData$phy
data <- trimmedData$data
```

## 1. Pagel's Test

Pagel's 1994 test of correlated evolution. Creates independent and dependent models of evolution and compares them using a likelihood ratio test.
```{r}
x<-data$ag
names(x)<-data$species
y<-data$care
names(y)<-data$species

phy2<-bind.tip(phy,tip.label="ROOT",edge.length=0,
    where=Ntip(phy)+1)

x<-as.factor(c(setNames(0,"ROOT"),
    setNames(as.character(x),names(x))))
y<-as.factor(c(setNames(0,"ROOT"),
    setNames(as.character(y),names(y))))

print(PagelsTest<-fitPagel(phy2, x, y, model = "ARD"))
```

## 2. Likelihood Ratio Test

This should be the same as Pagel's test. Independent and dependent models are created, this time using the same function we use to set up our Bayesian stuff later on, and the models are compared.

Independent Model
```{r, echo=F}
LegendAndRateMat <- getStateMat4Dat(data)
RateMat <- LegendAndRateMat$rate.mat
pars2equal <- list(c(3,8), c(5,7), c(1,6), c(2,4))
indStateMat <- equateStateMatPars(RateMat, pars2equal)
indModel<- corHMM(phy = phy, data = data, rate.cat = 1, root.p = c(1,0,0,0), rate.mat = indStateMat)
print(indModel)
```

Dependent Model
```{r, echo=F}
depModel<- corHMM(phy = phy, data = data, rate.cat = 1, root.p = c(1,0,0,0))
print(depModel)
```

Likelihood ratio and p-value
```{r, echo=F}
#likelihood ratio test, same as Pagel's test of correlated evolution used in my thesis
print(likRatio<- -2*(indModel$loglik-depModel$loglik))
print(p.val <- pchisq(likRatio, df = 4, lower.tail = F))
#my thesis found a p value of < 0.001 so this is good so far
```
## 3. AIC Comparison

Same models as 1 and 2 except compared using AIC instead of log likelihoods.

AIC comparison for the models from Pagel's test, AIC values and weights
```{r, echo=F}
print(aic1<-setNames(c(PagelsTest$independent.AIC, PagelsTest$dependent.AIC),c("independant","dependent")))
aic.w(aic1)
```

AIC comparison for our corHMM models, values and weights
```{r}
print(aic2<-setNames(c(indModel$AIC, depModel$AIC),c("independant","dependent")))
aic.w(aic2)
```
## 4. BayesTraits (with BayesFactors)

```{r, echo=F}
indBayesTraits<-read.table()
depBayesTraits<-read.table()
```

## 5. BayesTraits (with contrasts)

## 6. BayesTraits (RJHP)

## 7. Our corHMM Bayesian analysis

```{r, echo=F}
# ind_twoTrait_mcmc <- 
#   corhmm_mcmc(indModel,
#               p_args=list(nllfun=make_nllfun(indModel)),
#               n_cores = 3,
#               n_chains = 6,
#               ## these are per chain
#               n_burnin = 4000,
#               n_iter = 44000,
#               n_thin = 10,
#               seed = 101)
# saveRDS(ind_twoTrait_mcmc, file = "indTwoTraitMCMC.rds")
```

```{r, echo=F}
# dep_twoTrait_mcmc <- 
#   corhmm_mcmc(depModel,
#               p_args=list(nllfun=make_nllfun(depModel)),
#               n_cores = 3,
#               n_chains = 6,
#               ## these are per chain
#               n_burnin = 4000,
#               n_iter = 44000,
#               n_thin = 10,
#               seed = 101)
# saveRDS(dep_twoTrait_mcmc, file = "depTwoTraitMCMC.rds")
```


```{r, echo=F}
dep_mcmc<-readRDS("depTwoTraitMCMC.rds")
lattice::xyplot(dep_mcmc, layout=c(2,4), aspect="fill",
                as.table = TRUE)
```

```{r}
dep_mcmc[] <- lapply(dep_mcmc,
                       function(x) { 
                         colnames(x) <- c("q21", "q31", "q12", "q42",
                                          "q13", "q43", "q24", "q34")
                         return(x)
                       })

m1 <- as.mcmc(dep_mcmc)

df <- (as.data.frame(m1)
  %>% pivot_longer(everything(), names_to="var", values_to = "logval")
  %>% mutate(value = exp(logval))
)
ggplot(df, aes(x=value)) + facet_wrap(~var, nrow = 2, scales="free") +
  geom_histogram(bins = 100)

print(ggplot(df, aes(x=var, y=value))
      + geom_violin(fill="gray")
      + geom_hline(yintercept = 0, lty = 2)
      + ylim(0,0.03)
)

summary(m1)
```
