---
title: "Two Trait Model"
author: Lucas Eckert
output: html_document
---

The following are analyses of the correlation between parental care and accessory glands, done in 7 different ways. 

```{r, echo=F, include=F}
source("R/utils.R")
source("R/mcmc.R")
source("R/functions.R")
load_pkgs()
zmargin <- theme(panel.spacing = grid::unit(0, "lines"))
theme_set(theme_bw())
library(phytools)
```

```{r, echo=F}
allData <- read.csv("data/binaryTraitData.csv", header = TRUE)
traitData <- with(allData,
                  data.frame(species, ag, care, names=species))
fullPhy <- suppressWarnings(fishtree_phylogeny(traitData$species))
trimmedData <- comparative.data(fullPhy, traitData, names.col = names)
phy <- trimmedData$phy
data <- trimmedData$data
```

## 1. Pagel's Test

Pagel's 1994 test of correlated evolution. Creates independent and dependent models of evolution and compares them using a likelihood ratio test.
```{r, echo=F}
x<-data$ag
names(x)<-data$species
y<-data$care
names(y)<-data$species

phy2<-bind.tip(phy,tip.label="ROOT",edge.length=0,
    where=Ntip(phy)+1)

x<-as.factor(c(setNames(0,"ROOT"),
    setNames(as.character(x),names(x))))
y<-as.factor(c(setNames(0,"ROOT"),
    setNames(as.character(y),names(y))))

print(PagelsTest<-fitPagel(phy2, x, y, model = "ARD"))
```

## 2. Likelihood Ratio Test

This should be the same as Pagel's test. Independent and dependent models are created, this time using the same function we use to set up our Bayesian stuff later on.

Independent Model
```{r, echo=F}
LegendAndRateMat <- getStateMat4Dat(data)
RateMat <- LegendAndRateMat$rate.mat
pars2equal <- list(c(3,8), c(5,7), c(1,6), c(2,4))
indStateMat <- equateStateMatPars(RateMat, pars2equal)
indModel<- corHMM(phy = phy, data = data, rate.cat = 1, root.p = c(1,0,0,0), rate.mat = indStateMat)
print(indModel)
```

Dependent Model
```{r, echo=F}
depModel<- corHMM(phy = phy, data = data, rate.cat = 1, root.p = c(1,0,0,0))
print(depModel)
```

Likelihood ratio and p-value
```{r, echo=F}
#likelihood ratio test, same as Pagel's test of correlated evolution used in my thesis
print(likRatio<- -2*(indModel$loglik-depModel$loglik))
print(p.val <- pchisq(likRatio, df = 4, lower.tail = F))
#my thesis found a p value of < 0.001 so this is good so far
```
## 3. AIC Comparison

Same models as 1 and 2 except compared using AIC instead of log likelihoods.

AIC comparison for the models from Pagel's test, AIC values and weights
```{r, echo=F}
print(aic1<-setNames(c(PagelsTest$independent.AIC, PagelsTest$dependent.AIC),c("independant","dependent")))
aic.w(aic1)
```

AIC comparison for our corHMM models, values and weights
```{r, echo=F}
print(aic2<-setNames(c(indModel$AIC, depModel$AIC),c("independant","dependent")))
aic.w(aic2)
```
## 4. BayesTraits (with BayesFactors)

Create the models in BayesTraits and then compare using BayesFactors, via the harmonic means of the log likelihoods

```{r, echo=F}
indBayesTraits<-read.csv("indBayesTraits.csv", header = T)
depBayesTraits<-read.csv("depBayesTraits.csv", header = T)

print(indLik<-1/mean(1/indBayesTraits$Lh))
print(depLik<-1/mean(1/depBayesTraits$Lh))

print(BF<-2*(depLik-indLik))
```

## 5. BayesTraits (with contrasts)

Using the estimates from the dependent model from BayesTraits, contrasts on the effect of care on the gain, loss, and net-gain, of accessory glands

```{r, echo=F}
gain.ag.bt<-depBayesTraits$q24-depBayesTraits$q13
loss.ag.bt<-depBayesTraits$q42-depBayesTraits$q31
net.ag.bt<-gain.ag.bt-loss.ag.bt

df1<-data.frame(var="gain",value=gain.ag.bt)
df2<-data.frame(var="loss",value=loss.ag.bt)
df3<-data.frame(var="net",value=net.ag.bt)
df<-rbind(df1,df2,df3)

print(ggplot(df, aes(x=var, y=value))
      + geom_violin(fill="gray")
      + geom_hline(yintercept = 0, lty = 2)
      + coord_flip()
      )
```

## 6. BayesTraits (RJHP)

```{r}
revJump<-read.csv("rjBayesTraits.csv", header = T)
#to test if care has an effect on gaining ag's, i guess we can look at how often q13 qnd q24 are set to be different rates
#q13 is the 2nd rate in the model string and q24 is the 4th rate
#tho im not sure how to see how often those are different...
```

## 7. Our corHMM Bayesian analysis

```{r, echo=F}
data2<-na.omit(traitData[,1:3])
treeblock<-fishtree_complete_phylogeny(data2$species)

depTreeBlock<- corHMM(phy = treeblock[[1]], data = data2, rate.cat = 1, root.p = c(1,0,0,0))

dep_treeblock_mcmc <-
  corhmm_mcmc(depTreeBlock,
              p_args=list(nllfun=make_nllfun(depTreeBlock), treeblock=treeblock),
              n_cores = 3,
              n_chains = 6,
              ## these are per chain
              n_burnin = 4000,
              n_iter = 44000,
              n_thin = 10,
              seed = 101)
saveRDS(dep_treeblock_mcmc, file = "depTreeBlockMCMC.rds")
```

```{r, echo=F, include=F}
dep_mcmc<-readRDS("depTreeBlockMCMC.rds")
lattice::xyplot(dep_mcmc, layout=c(2,4), aspect="fill",
                as.table = TRUE)
sort(effectiveSize(dep_mcmc))
coda::gelman.diag(dep_mcmc)
```

```{r, echo=F}
dep_mcmc[] <- lapply(dep_mcmc,
                       function(x) { 
                         colnames(x) <- c("q21", "q31", "q12", "q42",
                                          "q13", "q43", "q24", "q34")
                         return(x)
                       })

m1 <- as.mcmc(dep_mcmc)

df <- (as.data.frame(m1)
  %>% pivot_longer(everything(), names_to="var", values_to = "logval")
  %>% mutate(value = exp(logval))
)
ggplot(df, aes(x=value)) + facet_wrap(~var, nrow = 2, scales="free") +
  geom_histogram(bins = 100)

print(ggplot(df, aes(x=var, y=value))
      + geom_violin(fill="gray")
      + geom_hline(yintercept = 0, lty = 2)
      + ylim(0,0.03)
)

summary(m1)
```
